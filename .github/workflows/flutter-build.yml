# å·¥ä½œæµåç§°
name: Build and Release APK

# è§¦å‘æ¡ä»¶
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# å®šä¹‰ä½œä¸š
jobs:
  build:
    name: Build APK
    # ä½¿ç”¨æ ‡å‡† Runnerï¼Œé¿å…æ’é˜Ÿ
    runs-on: ubuntu-latest

    # ä½œä¸šæ­¥éª¤
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          # æš‚æ—¶ç¦ç”¨ Gradle ç¼“å­˜ï¼Œæˆ‘ä»¬è¦æ‰‹åŠ¨æ¸…ç†
          # cache: gradle

      - name: Set up Flutter
        uses: subosito/flutter-action@v2.16.0
        with:
          channel: 'stable'
          cache: true

      # æ­¥éª¤ 4: æ„å»º APK (è¿™æ˜¯æœ€å…³é”®çš„éƒ¨åˆ†)
      - name: Build APK
        run: |
          echo "Starting ultimate clean build process..."

          # ã€æœ€ç»ˆä¿®å¤ã€‘ä¸º Gradle å¢åŠ æ›´å¤šå†…å­˜
          export GRADLE_OPTS="-Xmx6g -XX:MaxMetaspaceSize=2g"
          echo "âœ… Increased Gradle memory limit to 6GB."

          # æ¸…ç†é¡¹ç›®ï¼Œç¡®ä¿ä¸€ä¸ªå¹²å‡€çš„æ„å»ºç¯å¢ƒ
          flutter clean
          flutter pub cache clean
          rm -f pubspec.lock
          flutter pub get
          echo "âœ… Project cleaned and dependencies fetched."

          # ===================================================================
          # ã€ç»ˆæè¡¥ä¸ã€‘ä¸€æ¬¡æ€§ä¿®å¤æ‰€æœ‰æ’ä»¶çš„ compileSdk ç‰ˆæœ¬
          # ===================================================================
          echo "Applying universal patch to fix compileSdk for ALL plugins..."
          find /home/runner/.pub-cache/hosted/pub.dev -name "build.gradle" -path "*/android/*" -exec sed -i -e 's/compileSdkVersion 30/compileSdkVersion 34/g' -e 's/compileSdkVersion 31/compileSdkVersion 34/g' -e 's/compileSdkVersion 33/compileSdkVersion 34/g' {} \;
          echo "âœ… Universal patch applied. All plugins should now use compileSdk 34."

          # ===================================================================
          # ã€è¡¥ä¸ 1ã€‘ä¿®å¤ webview_cookie_manager çš„ AndroidManifest.xml
          # ===================================================================
          echo "Applying patch for webview_cookie_manager AndroidManifest.xml..."
          WEBVIEW_MANIFEST_PATH="/home/runner/.pub-cache/hosted/pub.dev/webview_cookie_manager-2.0.6/android/src/main/AndroidManifest.xml"
          if [ -f "$WEBVIEW_MANIFEST_PATH" ]; then
            sed -i '/package="io.flutter.plugins.webview_cookie_manager"/d' "$WEBVIEW_MANIFEST_PATH"
            echo "âœ… webview_cookie_manager patch applied successfully."
          else
            echo "âš ï¸ Warning: webview_cookie_manager manifest not found, skipping patch."
          fi
          # ===================================================================
          
          # ã€ç»ˆææ¸…ç†ã€‘åˆ é™¤æ‰€æœ‰ Gradle ç¼“å­˜ï¼Œç¡®ä¿æ„å»ºç¯å¢ƒç»å¯¹å¹²å‡€
          echo "ğŸ§¹ Performing ultimate Gradle cache cleanup..."
          rm -rf ~/.gradle/caches/
          rm -rf .gradle/
          echo "âœ… All Gradle caches have been purged."

          # å¼€å§‹æ„å»º Release ç‰ˆæœ¬çš„ APKï¼Œå¹¶æŒ‰ ABI åˆ†å‰²
          echo "ğŸš€ Starting ultimate Flutter build..."
          # ã€å…³é”®ã€‘é€šè¿‡ -P å‚æ•°å¼ºåˆ¶ç¦ç”¨æ‰€æœ‰æœ‰é—®é¢˜çš„ä¼˜åŒ–
          flutter build apk --release --split-per-abi -P android.enableJetifier=false -P org.gradle.configuration-cache=false -P org.gradle.caching=false
          echo "ğŸ‰ Flutter build finished."

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-apks
          path: build/app/outputs/flutter-apk/app-*.apk
